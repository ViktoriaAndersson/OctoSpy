
<!DOCTYPE html>
<html>
<head>
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <title>Data OctoSpy</title>
  <script src="https://cdn.plot.ly/plotly-2.18.2.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
  <style>
  #map { height: 300px; }
  </style>
</head>
<body style="background-color: lightblue;">
  <h1>OctoSpy</h1>
  <div id="plot" style="width:500px; height:400px;"></div>


  <p>
    Downloads:
  </p>
  <p>
    <a href="temperatures.txt" download><button style="background-color:blue; color:white; border-radius:15px;">Download temperatures</button></a>
  </p>
  <p>
    <a href="coordinates.txt" download><button style="background-color:blue; color:white; border-radius: 15px;">Download coordinates</button></a>
  </p>

  <div id="map">
  <script>
let temperature = 0.0;

var map = L.map('map').setView([57.12, 11.90], 13);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

let gpsMarker;

setInterval(function() {
  fetch('temperature.txt', {cache: "no-store"}).then(response => {
    if (response.ok) {
      return response.text();
    }
  }).then(text => {
    temperature = text;
  })



  fetch('coordinate.txt', {cache: "no-store"}).then(response => {
    if (response.ok) {
      return response.text();
    }
  }).then(text => {
    const s = text.split(' ');
    if (!gpsMarker) {
      gpsMarker = new L.marker([s[1], s[2]]).addTo(map)
        .bindPopup('Temperature: '+ temperature.substring(11, )+'&deg;C')
        .openPopup();
    } else {
      gpsMarker.setLatLng([s[1], s[2]]);
    }
  });


  fetch("temperatures.txt", {cache: "no-store"}).then(response => {
    if (response.ok) {
      return response.text();
    }
  }).then(text => {
    let t = [];
    let v = [];
    let t0 = 0;
    let tpre = 0;
    text.split('\n').reverse().every(function(line) {
      const s = line.split(' ');
      if (s.length == 2){
        tnow = (s[0]);
	const dt = tpre - tnow;
        if (tpre != 0 && dt > 10) {
          t0 = tpre;
          return false;
        }
        t.push(tnow);
        v.push(s[1]);
	tpre = tnow;      
      }
	    return true;
    });
    let plot = {
      x: t.map(e => e - t0),
      y: v,
      name: 'x',
      type: 'scatter'
    };
    var layout = {
      xaxis: {
        title: 'time (sec)',
      },
      yaxis: {
        title: 'temperature (&#176;C)',
      }
    };
    Plotly.newPlot('plot', [plot], layout);
  });
}, 500);




</script>
</body>
</html>




